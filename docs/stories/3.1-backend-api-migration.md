# Story 3.1: Backend API Migration from n8n to Express.js

## Status
Draft

## Story
**As a** backend developer,
**I want** to migrate all n8n workflow-based APIs to native Express.js endpoints,
**so that** we have a maintainable, scalable backend with proper TypeScript types and testability.

## Context
Currently, the backend logic is implemented as n8n workflows that serve webhook endpoints. While functional, this approach has limitations:
- No type safety or compile-time checks
- Difficult to test and debug
- Limited IDE support and autocomplete
- Hard to version control workflow changes
- Performance overhead from visual workflow execution
- Dependency on n8n runtime for all API operations

This story migrates all API endpoints to native Express.js implementation while maintaining backward compatibility with the existing mobile app.

## Acceptance Criteria
1. All authentication endpoints (register, login, token refresh) are migrated to Express.js
2. All lead management endpoints (CRUD operations) are migrated with proper validation
3. All task management endpoints are migrated
4. All interaction logging endpoints are migrated
5. JWT authentication middleware is implemented with proper error handling
6. Request validation middleware is implemented using express-validator
7. Error handling middleware provides consistent error responses
8. All endpoints return proper HTTP status codes and error messages
9. API response format matches existing n8n implementation for backward compatibility
10. Database queries use parameterized statements to prevent SQL injection
11. All endpoints have comprehensive unit tests with >80% coverage
12. API documentation is generated using Swagger/OpenAPI
13. Migration script exists to switch from n8n to Express.js with zero downtime

## Tasks / Subtasks

- [ ] **Task 1: Setup Express.js API Foundation** (AC: 1, 6, 7, 8, 12)
  - [ ] Create Express.js application with TypeScript configuration
  - [ ] Setup middleware stack (cors, helmet, body-parser, compression)
  - [ ] Implement centralized error handling middleware
  - [ ] Create API versioning structure (/api/v1/)
  - [ ] Setup Swagger/OpenAPI documentation generator
  - [ ] Create response formatter utilities for consistent API responses

- [ ] **Task 2: Implement Authentication System** (AC: 1, 5, 10)
  - [ ] Create JWT authentication middleware
  - [ ] Implement token generation and refresh logic
  - [ ] Create POST /api/v1/auth/register endpoint
  - [ ] Create POST /api/v1/auth/login endpoint
  - [ ] Create POST /api/v1/auth/refresh endpoint
  - [ ] Add password hashing with bcrypt (min 12 rounds)
  - [ ] Implement rate limiting for auth endpoints (5 attempts per 15 min)
  - [ ] Add request validation for email format and password strength

- [ ] **Task 3: Implement Lead Management API** (AC: 2, 6, 8, 10)
  - [ ] Create GET /api/v1/leads endpoint with pagination and filtering
  - [ ] Create GET /api/v1/leads/:leadId endpoint
  - [ ] Create POST /api/v1/leads endpoint with validation
  - [ ] Create PUT /api/v1/leads/:leadId endpoint
  - [ ] Create PUT /api/v1/leads/:leadId/status endpoint
  - [ ] Create DELETE /api/v1/leads/:leadId endpoint (soft delete)
  - [ ] Implement request validators using express-validator
  - [ ] Add user_id filtering to ensure data isolation
  - [ ] Create lead service layer for business logic

- [ ] **Task 4: Implement Task Management API** (AC: 3, 6, 8, 10)
  - [ ] Create GET /api/v1/tasks endpoint with filtering
  - [ ] Create GET /api/v1/tasks/:taskId endpoint
  - [ ] Create POST /api/v1/tasks endpoint with validation
  - [ ] Create PUT /api/v1/tasks/:taskId endpoint
  - [ ] Create PUT /api/v1/tasks/:taskId/complete endpoint
  - [ ] Create DELETE /api/v1/tasks/:taskId endpoint
  - [ ] Implement due date and priority validation
  - [ ] Add lead association validation

- [ ] **Task 5: Implement Interaction Logging API** (AC: 4, 6, 8, 10)
  - [ ] Create GET /api/v1/interactions endpoint
  - [ ] Create GET /api/v1/leads/:leadId/interactions endpoint
  - [ ] Create POST /api/v1/interactions endpoint with validation
  - [ ] Create PUT /api/v1/interactions/:interactionId endpoint
  - [ ] Implement interaction type validation (enum)
  - [ ] Add automatic timestamp recording

- [ ] **Task 6: Database Layer and Models** (AC: 10)
  - [ ] Create TypeScript interfaces for all database entities
  - [ ] Implement database connection pooling with pg-pool
  - [ ] Create base repository class with common CRUD methods
  - [ ] Implement UserRepository with parameterized queries
  - [ ] Implement LeadRepository with parameterized queries
  - [ ] Implement TaskRepository with parameterized queries
  - [ ] Implement InteractionRepository with parameterized queries
  - [ ] Add query logging for debugging

- [ ] **Task 7: Testing and Quality Assurance** (AC: 11)
  - [ ] Setup Jest test environment for API endpoints
  - [ ] Create test database and seed data
  - [ ] Write unit tests for authentication endpoints (>80% coverage)
  - [ ] Write unit tests for lead management endpoints (>80% coverage)
  - [ ] Write unit tests for task management endpoints (>80% coverage)
  - [ ] Write integration tests for end-to-end flows
  - [ ] Create API test collection in Postman/Thunder Client
  - [ ] Setup test CI pipeline

- [ ] **Task 8: Migration and Deployment** (AC: 9, 13)
  - [ ] Create API compatibility layer to match n8n responses
  - [ ] Implement feature flag system for gradual rollout
  - [ ] Create migration script to switch API endpoints
  - [ ] Setup blue-green deployment configuration
  - [ ] Create rollback procedure documentation
  - [ ] Update frontend API service to use new endpoints
  - [ ] Perform load testing to compare performance

## Dev Notes

### Architecture References
**Source Tree Context:**
- Backend location: `backend/src/`
- Routes: `backend/src/routes/` - API endpoint definitions
- Controllers: `backend/src/controllers/` - Request handling logic
- Services: `backend/src/services/` - Business logic layer
- Models: `backend/src/models/` - Database models and repositories
- Middleware: `backend/src/middleware/` - Auth, validation, error handling
- Utils: `backend/src/utils/` - Helper functions and utilities

**Key Files to Create/Update:**
```
backend/src/
├── app.ts                          # Express application setup
├── server.ts                       # Server startup
├── routes/
│   ├── auth.routes.ts             # Authentication endpoints
│   ├── leads.routes.ts            # Lead management endpoints
│   ├── tasks.routes.ts            # Task management endpoints
│   └── interactions.routes.ts     # Interaction logging endpoints
├── controllers/
│   ├── auth.controller.ts
│   ├── leads.controller.ts
│   ├── tasks.controller.ts
│   └── interactions.controller.ts
├── services/
│   ├── auth.service.ts
│   ├── leads.service.ts
│   ├── tasks.service.ts
│   └── interactions.service.ts
├── middleware/
│   ├── auth.middleware.ts         # JWT verification
│   ├── validate.middleware.ts     # Request validation
│   └── error.middleware.ts        # Error handling
└── models/
    ├── user.model.ts
    ├── lead.model.ts
    ├── task.model.ts
    └── interaction.model.ts
```

### Database Connection
- Use connection pooling with `pg-pool` (max: 20 connections)
- Connection string from environment: `process.env.DATABASE_URL`
- Always use parameterized queries: `db.query('SELECT * FROM leads WHERE user_id = $1', [userId])`
- Handle connection errors gracefully with retry logic

### Authentication
- JWT secret: `process.env.JWT_SECRET` (min 32 characters)
- Token expiry: 24 hours for access token, 7 days for refresh token
- Password hashing: `bcrypt.hash(password, 12)` (12 salt rounds minimum)
- Rate limiting: 5 login attempts per 15 minutes per IP

### API Response Format
All successful responses follow this structure:
```typescript
{
  success: true,
  data: any,        // Response payload
  message?: string  // Optional success message
}
```

All error responses follow this structure:
```typescript
{
  success: false,
  error: {
    code: string,      // Error code (e.g., 'VALIDATION_ERROR')
    message: string,   // Human-readable error message
    details?: any      // Optional error details
  }
}
```

### Request Validation
Use `express-validator` for all input validation:
```typescript
import { body, param, query, validationResult } from 'express-validator';

// Example validators
body('email').isEmail().normalizeEmail()
body('password').isLength({ min: 8 })
param('leadId').isInt()
```

### Error Handling
All errors should be thrown using custom error classes:
```typescript
class ValidationError extends Error {
  constructor(message: string, details?: any) {
    super(message);
    this.name = 'ValidationError';
    this.statusCode = 400;
    this.details = details;
  }
}
```

### Testing
**Test File Location:** `backend/src/__tests__/`
**Test Pattern:** `<feature>.test.ts` (e.g., `auth.test.ts`)
**Testing Framework:** Jest with Supertest for API testing
**Test Database:** Use separate test database with seed data
**Coverage Requirement:** Minimum 80% code coverage

**Test Structure:**
```typescript
describe('Auth API', () => {
  beforeAll(async () => {
    // Setup test database
  });

  afterAll(async () => {
    // Cleanup
  });

  describe('POST /api/v1/auth/register', () => {
    it('should register a new user with valid data', async () => {
      // Test implementation
    });

    it('should return 400 for invalid email', async () => {
      // Test implementation
    });
  });
});
```

### Migration Strategy
1. **Phase 1 (Week 1):** Implement Express.js endpoints alongside n8n
2. **Phase 2 (Week 2):** Test new endpoints with feature flags
3. **Phase 3 (Week 3):** Gradually migrate traffic (10% → 50% → 100%)
4. **Phase 4 (Week 4):** Deprecate n8n workflows after monitoring

### Security Considerations
- All endpoints require authentication except register/login
- Implement CORS with whitelist of allowed origins
- Use Helmet.js for security headers
- Sanitize all user inputs to prevent XSS
- Log all authentication attempts for audit trail
- Implement request size limits (10MB max)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-30 | 1.0 | Initial story creation | AI Assistant |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
