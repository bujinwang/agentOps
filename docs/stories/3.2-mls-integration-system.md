# Story 3.2: MLS Integration and Property Synchronization System

## Status
Draft

## Story
**As a** real estate agent,
**I want** the system to automatically synchronize property listings from MLS providers,
**so that** I always have up-to-date property information without manual data entry.

## Context
The application has property management UI and database schema ready, but lacks the actual MLS integration. Real estate agents need access to current MLS listings to show clients available properties. Manual data entry is time-consuming and error-prone. This story implements automated synchronization with MLS providers using RETS (Real Estate Transaction Standard) and modern REST APIs.

## Acceptance Criteria
1. System can connect to at least one MLS provider using RETS protocol
2. Initial property sync imports all active listings from MLS
3. Incremental sync runs every 4 hours to fetch updates
4. Property data is normalized and stored in the properties table
5. Property images are downloaded and stored in cloud storage (AWS S3)
6. Sync status and history are tracked in mls_sync_status and mls_sync_history tables
7. Sync errors are logged in mls_sync_errors table with retry logic
8. Admin dashboard shows sync status, last sync time, and error count
9. Manual sync can be triggered from admin interface
10. Sync conflicts are handled (e.g., property deleted in MLS but has local edits)
11. Property status changes (sold, pending, withdrawn) are reflected immediately
12. System handles rate limiting from MLS providers gracefully
13. Sync process runs in background without blocking API requests
14. Performance: Can sync 10,000 properties in under 30 minutes
15. Failed syncs have automatic retry with exponential backoff

## Tasks / Subtasks

- [ ] **Task 1: MLS Provider Configuration and Setup** (AC: 1, 12)
  - [ ] Create MLS provider configuration schema (credentials, endpoints, rate limits)
  - [ ] Implement secure credential storage using AWS Secrets Manager
  - [ ] Create MLS provider registry system to support multiple providers
  - [ ] Implement RETS client library integration (using `rets-client` package)
  - [ ] Setup provider-specific adapters pattern for extensibility
  - [ ] Implement rate limiting handler (respect MLS provider limits)
  - [ ] Create connection health check endpoint
  - [ ] Add provider failover logic for redundancy

- [ ] **Task 2: Property Data Synchronization Engine** (AC: 2, 3, 4, 13, 14)
  - [ ] Create sync orchestration service (`MLSSyncService`)
  - [ ] Implement initial full sync logic (fetch all active listings)
  - [ ] Implement incremental sync logic (delta updates only)
  - [ ] Create property data transformation layer (MLS → internal schema)
  - [ ] Implement field mapping configuration (customizable per provider)
  - [ ] Add data validation and sanitization before storage
  - [ ] Create batch insert/update logic for performance (1000 records/batch)
  - [ ] Implement background job queue using Bull/BullMQ
  - [ ] Setup cron job for scheduled syncs (every 4 hours)
  - [ ] Add sync progress tracking and reporting

- [ ] **Task 3: Media Management and Storage** (AC: 5)
  - [ ] Setup AWS S3 bucket for property images
  - [ ] Implement image download and upload service
  - [ ] Create image optimization pipeline (resize, compress, webp conversion)
  - [ ] Generate multiple image sizes (thumbnail, medium, large)
  - [ ] Implement image URL caching for performance
  - [ ] Add retry logic for failed image downloads
  - [ ] Create cleanup job for orphaned images
  - [ ] Implement CDN integration (CloudFront) for image delivery

- [ ] **Task 4: Sync Status and History Tracking** (AC: 6, 7, 8)
  - [ ] Implement sync status recording in mls_sync_status table
  - [ ] Create sync history logger for audit trail
  - [ ] Implement error logging with full context (mls_sync_errors)
  - [ ] Create sync metrics collector (properties added/updated/deleted)
  - [ ] Implement real-time sync progress WebSocket updates
  - [ ] Create sync dashboard API endpoints
  - [ ] Build admin UI component for sync monitoring
  - [ ] Add alerting for sync failures (email/Slack notifications)

- [ ] **Task 5: Error Handling and Recovery** (AC: 7, 10, 15)
  - [ ] Implement exponential backoff retry logic (3 attempts max)
  - [ ] Create error categorization (network, data, authentication)
  - [ ] Implement dead letter queue for persistently failing records
  - [ ] Add conflict resolution strategy (MLS wins vs. manual merge)
  - [ ] Create manual conflict review interface for admins
  - [ ] Implement rollback mechanism for failed syncs
  - [ ] Add data integrity checks post-sync
  - [ ] Create sync recovery procedures documentation

- [ ] **Task 6: Property Status Management** (AC: 11)
  - [ ] Implement real-time property status update webhooks (if available)
  - [ ] Create status change event system
  - [ ] Add automatic status transition logic (active → sold → archived)
  - [ ] Implement property lifecycle tracking
  - [ ] Create notifications for status changes
  - [ ] Add status history logging
  - [ ] Implement status-based filtering in property queries

- [ ] **Task 7: Manual Sync Controls** (AC: 9)
  - [ ] Create POST /api/v1/admin/mls/sync endpoint for manual trigger
  - [ ] Implement sync cancellation logic
  - [ ] Add sync priority queue (manual syncs get priority)
  - [ ] Create provider-specific sync endpoints
  - [ ] Implement partial sync (single property or neighborhood)
  - [ ] Add dry-run mode for testing
  - [ ] Create sync preview feature (show what will change)

- [ ] **Task 8: Testing and Performance Optimization** (AC: 14)
  - [ ] Create mock MLS provider for testing
  - [ ] Write unit tests for sync engine (>80% coverage)
  - [ ] Create integration tests with mock RETS server
  - [ ] Perform load testing with 10,000+ properties
  - [ ] Optimize database queries with proper indexes
  - [ ] Implement connection pooling for MLS API calls
  - [ ] Add caching layer for frequently accessed data
  - [ ] Profile and optimize memory usage during sync

## Dev Notes

### Architecture References
**Source Tree Context:**
```
backend/src/
├── services/mls/
│   ├── mls-sync.service.ts        # Main sync orchestration
│   ├── rets-client.service.ts     # RETS protocol client
│   ├── property-mapper.service.ts  # Data transformation
│   └── media-sync.service.ts      # Image download/upload
├── providers/
│   ├── base-mls-provider.ts       # Abstract provider class
│   ├── rets-provider.ts           # RETS implementation
│   └── rest-api-provider.ts       # Modern REST API provider
├── models/
│   ├── property.model.ts          # Property entity
│   ├── mls-sync-status.model.ts   # Sync status tracking
│   └── property-media.model.ts    # Property images
├── jobs/
│   ├── mls-sync.job.ts           # Scheduled sync job
│   └── image-sync.job.ts         # Image download job
└── controllers/
    └── admin/mls-admin.controller.ts  # Admin controls
```

### MLS Provider Configuration
**Environment Variables:**
```env
# MLS Provider Settings
MLS_PROVIDER=RETS  # or REST_API
MLS_LOGIN_URL=https://rets.provider.com/login
MLS_USERNAME=your_username
MLS_PASSWORD=your_password
MLS_USER_AGENT=YourApp/1.0

# AWS S3 Configuration
AWS_S3_BUCKET=real-estate-crm-properties
AWS_S3_REGION=us-east-1
AWS_S3_ACCESS_KEY_ID=your_access_key
AWS_S3_SECRET_ACCESS_KEY=your_secret_key

# Sync Configuration
MLS_SYNC_INTERVAL_HOURS=4
MLS_SYNC_BATCH_SIZE=1000
MLS_MAX_RETRY_ATTEMPTS=3
```

### RETS Client Setup
Use `rets-client` npm package for RETS protocol:
```typescript
import { RetsClient } from 'rets-client';

const retsClient = new RetsClient({
  loginUrl: process.env.MLS_LOGIN_URL,
  username: process.env.MLS_USERNAME,
  password: process.env.MLS_PASSWORD,
  userAgent: process.env.MLS_USER_AGENT,
  version: 'RETS/1.7.2'
});
```

### Data Mapping
**MLS Field → Internal Field Mapping:**
```typescript
const fieldMapping = {
  // Core fields
  'ListingId': 'mls_listing_id',
  'ListPrice': 'price',
  'Address': 'address',
  'City': 'city',
  'StateOrProvince': 'state',
  'PostalCode': 'postal_code',
  
  // Property details
  'PropertyType': 'property_type',
  'BedroomsTotal': 'bedrooms',
  'BathroomsTotal': 'bathrooms',
  'BuildingAreaTotal': 'square_feet',
  'YearBuilt': 'year_built',
  
  // Status and dates
  'StandardStatus': 'status',
  'ListingContractDate': 'listed_date',
  'ModificationTimestamp': 'updated_at',
  
  // Features
  'InteriorFeatures': 'interior_features',
  'Appliances': 'appliances',
  'ParkingFeatures': 'parking_features'
};
```

### Sync Process Flow
1. **Initialization:**
   - Check last sync timestamp from mls_sync_status
   - Determine sync type (full or incremental)
   - Record sync start in mls_sync_history

2. **Data Fetch:**
   - Query MLS provider with appropriate filters
   - Handle pagination (fetch in batches of 1000)
   - Apply rate limiting (respect provider limits)

3. **Data Transformation:**
   - Map MLS fields to internal schema
   - Validate required fields
   - Normalize data formats (prices, dates, enums)
   - Handle missing or invalid data gracefully

4. **Data Storage:**
   - Batch insert/update properties (1000 per batch)
   - Update property status (active, sold, pending)
   - Mark properties as deleted if not in MLS anymore
   - Record sync metrics

5. **Media Sync:**
   - Queue image download jobs
   - Download images from MLS provider
   - Upload to S3 with proper naming
   - Generate thumbnails and optimized versions
   - Update property_media table

6. **Completion:**
   - Record sync completion in mls_sync_status
   - Log final metrics (added, updated, deleted counts)
   - Send notifications if errors occurred
   - Trigger cache invalidation

### Database Schema Usage
**Tables:**
- `properties` - Main property data
- `property_media` - Property images and media
- `mls_sync_status` - Current sync state per provider
- `mls_sync_history` - Audit trail of all syncs
- `mls_sync_errors` - Error log with retry tracking

**Indexes Required:**
```sql
CREATE INDEX idx_properties_mls_listing_id ON properties(mls_listing_id);
CREATE INDEX idx_properties_status_updated ON properties(status, updated_at);
CREATE INDEX idx_mls_sync_status_provider ON mls_sync_status(provider_id);
CREATE INDEX idx_mls_sync_history_sync_id ON mls_sync_history(sync_id);
```

### Error Handling Strategy
**Error Categories:**
1. **Authentication Errors:** Retry immediately, then alert admin
2. **Network Errors:** Retry with exponential backoff (5s, 15s, 45s)
3. **Data Validation Errors:** Log and skip record, continue sync
4. **Rate Limit Errors:** Wait for rate limit reset, then resume

**Retry Logic:**
```typescript
async function retryWithBackoff(fn: Function, maxAttempts = 3) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      if (attempt === maxAttempts) throw error;
      const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

### Performance Optimization
- **Batch Processing:** Insert/update 1000 records at once
- **Connection Pooling:** Reuse database connections
- **Parallel Processing:** Download images in parallel (max 10 concurrent)
- **Caching:** Cache provider metadata and field mappings
- **Indexing:** Ensure all foreign keys and filter fields are indexed

### Testing
**Test File Location:** `backend/src/__tests__/mls/`
**Mock Provider:** Create mock RETS server for integration tests
**Test Data:** Use sample MLS XML responses from real providers
**Test Coverage:** Minimum 80% for sync engine and data mappers

**Key Test Scenarios:**
1. Initial full sync with 1000+ properties
2. Incremental sync with updates and deletions
3. Error handling (network failures, invalid data)
4. Rate limiting and backoff
5. Conflict resolution
6. Image download and storage
7. Performance with 10,000+ properties

### Monitoring and Alerts
**Metrics to Track:**
- Sync duration and throughput
- Success/failure rates
- Error types and frequency
- Memory and CPU usage during sync
- API call latency to MLS provider

**Alerts:**
- Sync failure (after 3 retries)
- Sync duration > 30 minutes
- Error rate > 5%
- No successful sync in 24 hours

### Security Considerations
- Store MLS credentials in AWS Secrets Manager (never in code)
- Encrypt sensitive property data at rest
- Use IAM roles for S3 access (not access keys)
- Validate and sanitize all MLS data before storage
- Implement audit logging for all sync operations
- Rate limit admin sync triggers to prevent abuse

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-30 | 1.0 | Initial story creation | AI Assistant |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
