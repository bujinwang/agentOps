# Story 3.3: Automated Workflow Execution Engine

## Status
Draft

## Story
**As a** real estate agent,
**I want** the system to automatically execute follow-up workflows based on lead scoring and engagement,
**so that** no lead falls through the cracks and I can focus on high-value activities.

## Context
The application has workflow UI (WorkflowsListScreen, WorkflowEditorScreen) and database schema ready, but lacks the execution engine. Agents need automated follow-up sequences that trigger based on lead behavior and scores. This story implements a flexible workflow engine that can execute multi-step sequences with delays, conditions, and actions.

## Acceptance Criteria
1. Workflow engine can execute workflows with multiple sequential steps
2. Workflows support trigger conditions (lead score, status change, time-based)
3. Workflows support action types (email, SMS, task creation, status update)
4. Workflows support delays between steps (hours, days, weeks)
5. Workflows support conditional branching (if lead score > 80, do X, else Y)
6. Email actions use templates with variable substitution
7. SMS actions integrate with Twilio API
8. Task actions create tasks in the tasks table with proper assignments
9. Workflow executions are tracked in workflow_executions table
10. Failed actions have retry logic with exponential backoff (3 attempts)
11. Workflows can be paused, resumed, or cancelled by users
12. Workflow analytics track conversion rates and engagement
13. System processes 1000+ workflow steps per minute
14. Workflows respect user timezone preferences for scheduling
15. Admin can preview workflow execution before activating

## Tasks / Subtasks

- [ ] **Task 1: Workflow Engine Core** (AC: 1, 2, 4, 5, 13)
  - [ ] Create WorkflowEngine service class
  - [ ] Implement workflow step execution loop
  - [ ] Create workflow trigger evaluation system
  - [ ] Implement delay scheduling using job queue
  - [ ] Add conditional branching logic evaluator
  - [ ] Create workflow state machine (pending → running → completed → failed)
  - [ ] Implement parallel step execution where possible
  - [ ] Add workflow execution context (variables, lead data)
  - [ ] Create workflow execution queue using Bull/BullMQ
  - [ ] Implement workflow priority system

- [ ] **Task 2: Trigger System** (AC: 2)
  - [ ] Create trigger types enum (score_change, status_change, time_based, manual)
  - [ ] Implement score threshold trigger (e.g., score > 80)
  - [ ] Implement status change trigger (e.g., New → Contacted)
  - [ ] Implement time-based trigger (e.g., 24 hours after creation)
  - [ ] Implement inactivity trigger (e.g., no contact in 7 days)
  - [ ] Create trigger evaluation engine
  - [ ] Add trigger cooldown to prevent duplicate executions
  - [ ] Implement trigger priority and ordering
  - [ ] Create manual workflow trigger endpoint

- [ ] **Task 3: Action Handlers** (AC: 3, 6, 7, 8)
  - [ ] Create base ActionHandler abstract class
  - [ ] Implement EmailActionHandler with template rendering
  - [ ] Implement SMSActionHandler with Twilio integration
  - [ ] Implement TaskActionHandler for task creation
  - [ ] Implement StatusUpdateActionHandler
  - [ ] Implement LeadScoreActionHandler
  - [ ] Implement WaitActionHandler for delays
  - [ ] Create action registry system
  - [ ] Add action parameter validation
  - [ ] Implement action result tracking

- [ ] **Task 4: Email Template System** (AC: 6)
  - [ ] Create email template storage in database
  - [ ] Implement template variable substitution ({{firstName}}, {{leadScore}})
  - [ ] Add template preview functionality
  - [ ] Create default email templates (welcome, follow-up, nurture)
  - [ ] Implement HTML email rendering
  - [ ] Add attachment support for emails
  - [ ] Integrate with SendGrid/AWS SES for email delivery
  - [ ] Track email opens and clicks
  - [ ] Handle unsubscribe links

- [ ] **Task 5: SMS Integration** (AC: 7)
  - [ ] Setup Twilio account and credentials
  - [ ] Create SMS service wrapper
  - [ ] Implement SMS template system
  - [ ] Add SMS delivery tracking
  - [ ] Handle SMS opt-out/opt-in
  - [ ] Implement SMS rate limiting (carrier limits)
  - [ ] Add SMS delivery status webhooks
  - [ ] Create SMS cost tracking

- [ ] **Task 6: Workflow Execution Tracking** (AC: 9, 10, 12)
  - [ ] Implement workflow execution logger
  - [ ] Track execution start/end times
  - [ ] Record each step execution with result
  - [ ] Log errors with full context
  - [ ] Implement retry logic with exponential backoff
  - [ ] Track workflow completion metrics (time, success rate)
  - [ ] Create execution history API endpoints
  - [ ] Add execution visualization for admins
  - [ ] Implement conversion attribution (workflow → closed deal)

- [ ] **Task 7: Workflow Control System** (AC: 11)
  - [ ] Create pause workflow functionality
  - [ ] Implement resume workflow from last checkpoint
  - [ ] Add cancel workflow with cleanup
  - [ ] Create workflow restart capability
  - [ ] Implement workflow version management
  - [ ] Add workflow dry-run mode for testing
  - [ ] Create workflow step override for manual intervention
  - [ ] Implement workflow scheduling (start at specific time)

- [ ] **Task 8: Analytics and Reporting** (AC: 12)
  - [ ] Create workflow performance dashboard
  - [ ] Track conversion rates per workflow
  - [ ] Calculate ROI per workflow (revenue attributed / cost)
  - [ ] Track engagement metrics (email opens, clicks, SMS replies)
  - [ ] Implement A/B testing framework for workflows
  - [ ] Create workflow comparison reports
  - [ ] Add funnel visualization
  - [ ] Generate workflow optimization recommendations

- [ ] **Task 9: Timezone and Scheduling** (AC: 14)
  - [ ] Store user timezone preferences
  - [ ] Implement timezone-aware scheduling
  - [ ] Add business hours constraints (no emails at night)
  - [ ] Create optimal send time algorithm
  - [ ] Handle daylight saving time transitions
  - [ ] Add holiday calendar integration
  - [ ] Implement send time optimization based on engagement data

- [ ] **Task 10: Testing and Performance** (AC: 13, 15)
  - [ ] Create mock action handlers for testing
  - [ ] Write unit tests for workflow engine (>80% coverage)
  - [ ] Create integration tests for complete workflows
  - [ ] Load test with 10,000+ concurrent workflow executions
  - [ ] Test retry and error handling scenarios
  - [ ] Implement workflow preview/dry-run feature
  - [ ] Profile and optimize execution performance
  - [ ] Test timezone and scheduling edge cases

## Dev Notes

### Architecture References
**Source Tree Context:**
```
backend/src/
├── services/workflow/
│   ├── workflow-engine.service.ts      # Core execution engine
│   ├── trigger-evaluator.service.ts    # Trigger condition evaluation
│   ├── action-registry.service.ts      # Action handler registry
│   └── workflow-scheduler.service.ts   # Delay and scheduling
├── actions/
│   ├── base-action.handler.ts          # Abstract action handler
│   ├── email-action.handler.ts         # Email sending
│   ├── sms-action.handler.ts           # SMS via Twilio
│   ├── task-action.handler.ts          # Task creation
│   ├── status-update-action.handler.ts # Lead status updates
│   └── wait-action.handler.ts          # Delay execution
├── models/
│   ├── workflow.model.ts               # Workflow definition
│   ├── workflow-execution.model.ts     # Execution tracking
│   └── workflow-step.model.ts          # Step tracking
├── jobs/
│   ├── workflow-trigger.job.ts         # Trigger evaluation job
│   ├── workflow-execution.job.ts       # Step execution job
│   └── workflow-cleanup.job.ts         # Cleanup completed workflows
└── templates/
    ├── email-templates.ts              # Email template definitions
    └── sms-templates.ts                # SMS template definitions
```

### Workflow Definition Schema
**Workflow JSON Structure:**
```json
{
  "workflowId": 1,
  "name": "New Lead Follow-up",
  "trigger": {
    "type": "score_change",
    "condition": "lead.score >= 70"
  },
  "steps": [
    {
      "id": "step-1",
      "type": "email",
      "delay": 0,
      "config": {
        "templateId": "welcome-email",
        "subject": "Welcome {{firstName}}!",
        "variables": ["firstName", "lastName"]
      }
    },
    {
      "id": "step-2",
      "type": "wait",
      "delay": 86400, // 24 hours in seconds
      "config": {}
    },
    {
      "id": "step-3",
      "type": "task",
      "delay": 0,
      "config": {
        "title": "Follow up call with {{firstName}} {{lastName}}",
        "priority": "High",
        "dueDate": "+2days"
      },
      "condition": "lead.status === 'Contacted'"
    }
  ]
}
```

### Trigger Evaluation
**Trigger Types and Evaluation:**
```typescript
interface TriggerConfig {
  type: 'score_change' | 'status_change' | 'time_based' | 'inactivity' | 'manual';
  condition: string;  // JavaScript expression
  cooldown?: number;  // Seconds before re-triggering
}

// Evaluation example
function evaluateTrigger(trigger: TriggerConfig, lead: Lead): boolean {
  const context = {
    lead,
    now: new Date(),
    daysSinceCreated: (Date.now() - lead.createdAt.getTime()) / (1000 * 60 * 60 * 24)
  };
  
  // Use vm2 or similar for safe evaluation
  return safeEval(trigger.condition, context);
}
```

### Action Handler Pattern
**Base Action Handler:**
```typescript
abstract class BaseActionHandler {
  abstract get type(): string;
  
  abstract async execute(
    config: ActionConfig,
    context: ExecutionContext
  ): Promise<ActionResult>;
  
  async retry(
    config: ActionConfig,
    context: ExecutionContext,
    attempt: number
  ): Promise<ActionResult> {
    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
    await sleep(delay);
    return this.execute(config, context);
  }
}
```

**Email Action Handler Example:**
```typescript
class EmailActionHandler extends BaseActionHandler {
  get type() { return 'email'; }
  
  async execute(config: EmailActionConfig, context: ExecutionContext) {
    const { lead, workflow } = context;
    
    // Render template with variables
    const body = this.renderTemplate(config.templateId, {
      firstName: lead.firstName,
      lastName: lead.lastName,
      agentName: workflow.ownerName
    });
    
    // Send email via SendGrid/SES
    const result = await this.emailService.send({
      to: lead.email,
      subject: config.subject,
      body,
      trackOpens: true,
      trackClicks: true
    });
    
    // Log interaction
    await this.interactionService.create({
      leadId: lead.leadId,
      type: 'Email Sent',
      content: body,
      workflowExecutionId: context.executionId
    });
    
    return {
      success: true,
      data: { messageId: result.id }
    };
  }
}
```

### Job Queue Configuration
**Bull Queue Setup:**
```typescript
import Queue from 'bull';

const workflowQueue = new Queue('workflow-execution', {
  redis: process.env.REDIS_URL,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 5000 // 5 seconds initial delay
    },
    removeOnComplete: true,
    removeOnFail: false
  }
});

// Process jobs
workflowQueue.process(10, async (job) => {
  const { workflowId, leadId, stepId } = job.data;
  await workflowEngine.executeStep(workflowId, leadId, stepId);
});
```

### Template Variable Substitution
**Template Rendering:**
```typescript
function renderTemplate(template: string, variables: Record<string, any>): string {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return variables[key] || match;
  });
}

// Example
const template = "Hi {{firstName}}, your score is {{score}}!";
const rendered = renderTemplate(template, {
  firstName: "John",
  score: 85
});
// Result: "Hi John, your score is 85!"
```

### Twilio SMS Integration
**SMS Configuration:**
```env
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=+1234567890
```

**SMS Service:**
```typescript
import twilio from 'twilio';

class SMSService {
  private client = twilio(
    process.env.TWILIO_ACCOUNT_SID,
    process.env.TWILIO_AUTH_TOKEN
  );
  
  async send(to: string, body: string): Promise<MessageInstance> {
    return await this.client.messages.create({
      to,
      from: process.env.TWILIO_PHONE_NUMBER,
      body
    });
  }
}
```

### Workflow Execution Context
**Execution Context Object:**
```typescript
interface ExecutionContext {
  executionId: number;
  workflowId: number;
  leadId: number;
  lead: Lead;
  workflow: Workflow;
  userId: number;
  variables: Record<string, any>;
  metadata: Record<string, any>;
}
```

### Database Schema Usage
**Tables:**
- `workflows` - Workflow definitions with JSON configuration
- `workflow_sequences` - Individual steps in workflows
- `workflow_executions` - Execution instances tracking
- `workflow_execution_steps` - Individual step execution results

**Key Queries:**
```sql
-- Get pending workflow executions
SELECT * FROM workflow_executions 
WHERE status = 'pending' 
  AND scheduled_at <= NOW()
ORDER BY priority DESC, scheduled_at ASC;

-- Track workflow performance
SELECT 
  w.workflow_id,
  w.name,
  COUNT(*) as total_executions,
  SUM(CASE WHEN we.status = 'completed' THEN 1 ELSE 0 END) as successful,
  AVG(we.completion_time) as avg_time
FROM workflows w
JOIN workflow_executions we ON w.workflow_id = we.workflow_id
WHERE we.created_at >= NOW() - INTERVAL '30 days'
GROUP BY w.workflow_id, w.name;
```

### Performance Optimization
- **Batch Trigger Evaluation:** Evaluate 100 leads at once
- **Parallel Execution:** Execute independent steps in parallel
- **Queue Prioritization:** High-value leads get priority
- **Caching:** Cache workflow definitions in Redis
- **Connection Pooling:** Reuse database and API connections

### Testing
**Test File Location:** `backend/src/__tests__/workflow/`
**Testing Framework:** Jest with Bull test utilities
**Mock Services:** Mock email and SMS services for testing

**Key Test Scenarios:**
1. Simple linear workflow (3 steps)
2. Conditional branching workflow
3. Workflow with delays and scheduling
4. Error handling and retry logic
5. Workflow pause/resume/cancel
6. Performance with 1000+ concurrent executions
7. Timezone and scheduling edge cases
8. Template rendering and variable substitution

### Monitoring and Alerts
**Metrics to Track:**
- Workflow execution throughput (executions/minute)
- Average execution time per workflow
- Success vs. failure rates
- Email delivery rates and engagement
- SMS delivery rates
- Action-specific metrics (open rates, click rates)

**Alerts:**
- Workflow execution failure rate > 10%
- Email delivery failure rate > 5%
- Queue backlog > 1000 pending executions
- Average execution time > 5 minutes

### Security Considerations
- Validate all workflow configurations before execution
- Sanitize template variables to prevent injection
- Rate limit workflow executions per user
- Encrypt sensitive data in workflow_executions table
- Audit log all workflow modifications
- Implement workflow approval process for high-value actions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-30 | 1.0 | Initial story creation | AI Assistant |

## Dev Agent Record
*This section will be populated during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*
