<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Coverage Dashboard - Real Estate CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .files-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .files-table h3 {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .coverage-high { color: #28a745; }
        .coverage-medium { color: #ffc107; }
        .coverage-low { color: #dc3545; }

        .recommendations {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .recommendations h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .recommendation-item {
            padding: 15px;
            border-left: 4px solid;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .recommendation-high { border-left-color: #dc3545; }
        .recommendation-medium { border-left-color: #ffc107; }
        .recommendation-low { border-left-color: #28a745; }

        .recommendation-item h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .recommendation-item p {
            color: #666;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§ª Test Coverage Dashboard</h1>
            <p>Real Estate CRM - Comprehensive Test Coverage Analysis</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="overall-coverage">0%</div>
                <div class="metric-label">Overall Coverage</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%; background: #28a745;"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="statements-coverage">0%</div>
                <div class="metric-label">Statements</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="statements-progress" style="width: 0%; background: #007bff;"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="branches-coverage">0%</div>
                <div class="metric-label">Branches</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="branches-progress" style="width: 0%; background: #ffc107;"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="functions-coverage">0%</div>
                <div class="metric-label">Functions</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="functions-progress" style="width: 0%; background: #dc3545;"></div>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3>Coverage by Metric Type</h3>
                <canvas id="coverageChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>Coverage by Directory</h3>
                <canvas id="directoryChart"></canvas>
            </div>
        </div>

        <div class="files-table">
            <h3>ðŸ“‚ File Coverage Details</h3>
            <table id="files-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Statements</th>
                        <th>Branches</th>
                        <th>Functions</th>
                        <th>Lines</th>
                        <th>Overall</th>
                    </tr>
                </thead>
                <tbody id="files-table-body">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            Loading coverage data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="recommendations">
            <h3>ðŸ’¡ Recommendations</h3>
            <div id="recommendations-list">
                <div style="text-align: center; padding: 40px; color: #666;">
                    Loading recommendations...
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Generated on <span id="generated-date"></span> | Real Estate CRM QA Suite</p>
        </div>
    </div>

    <script>
        // Load coverage data
        async function loadCoverageData() {
            try {
                const response = await fetch('./coverage/coverage-report.json');
                if (!response.ok) {
                    throw new Error('Coverage report not found');
                }
                return await response.json();
            } catch (error) {
                console.error('Failed to load coverage data:', error);
                return null;
            }
        }

        // Update metrics display
        function updateMetrics(data) {
            if (!data || !data.summary) return;

            const summary = data.summary;

            // Update overall metrics
            document.getElementById('overall-coverage').textContent = summary.overall.percentage + '%';
            document.getElementById('overall-progress').style.width = summary.overall.percentage + '%';

            document.getElementById('statements-coverage').textContent = summary.statements.percentage + '%';
            document.getElementById('statements-progress').style.width = summary.statements.percentage + '%';

            document.getElementById('branches-coverage').textContent = summary.branches.percentage + '%';
            document.getElementById('branches-progress').style.width = summary.branches.percentage + '%';

            document.getElementById('functions-coverage').textContent = summary.functions.percentage + '%';
            document.getElementById('functions-progress').style.width = summary.functions.percentage + '%';

            // Update progress bar colors based on coverage
            updateProgressBarColor('overall-progress', summary.overall.percentage);
            updateProgressBarColor('statements-progress', summary.statements.percentage);
            updateProgressBarColor('branches-progress', summary.branches.percentage);
            updateProgressBarColor('functions-progress', summary.functions.percentage);
        }

        function updateProgressBarColor(elementId, percentage) {
            const element = document.getElementById(elementId);
            if (percentage >= 80) {
                element.style.background = '#28a745'; // Green
            } else if (percentage >= 60) {
                element.style.background = '#ffc107'; // Yellow
            } else {
                element.style.background = '#dc3545'; // Red
            }
        }

        // Create coverage chart
        function createCoverageChart(data) {
            const ctx = document.getElementById('coverageChart').getContext('2d');
            const summary = data.summary;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Statements', 'Branches', 'Functions', 'Lines'],
                    datasets: [{
                        data: [
                            summary.statements.percentage,
                            summary.branches.percentage,
                            summary.functions.percentage,
                            summary.lines.percentage
                        ],
                        backgroundColor: [
                            '#007bff',
                            '#ffc107',
                            '#dc3545',
                            '#28a745'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create directory chart
        function createDirectoryChart(data) {
            const ctx = document.getElementById('directoryChart').getContext('2d');
            const directories = Object.entries(data.byDirectory)
                .sort((a, b) => b[1].statements.percentage - a[1].statements.percentage)
                .slice(0, 8); // Top 8 directories

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: directories.map(([dir]) => dir || 'root'),
                    datasets: [{
                        label: 'Coverage %',
                        data: directories.map(([, data]) => data.statements.percentage),
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update files table
        function updateFilesTable(data) {
            const tbody = document.getElementById('files-table-body');
            const files = Object.entries(data.byFile)
                .sort((a, b) => a[1].overall - b[1].overall) // Sort by lowest coverage first
                .slice(0, 20); // Show top 20 files

            tbody.innerHTML = files.map(([filePath, fileData]) => `
                <tr>
                    <td>${filePath}</td>
                    <td class="${getCoverageClass(fileData.statements.percentage)}">${fileData.statements.percentage}%</td>
                    <td class="${getCoverageClass(fileData.branches.percentage)}">${fileData.branches.percentage}%</td>
                    <td class="${getCoverageClass(fileData.functions.percentage)}">${fileData.functions.percentage}%</td>
                    <td class="${getCoverageClass(fileData.lines.percentage)}">${fileData.lines.percentage}%</td>
                    <td class="${getCoverageClass(fileData.overall)}"><strong>${fileData.overall}%</strong></td>
                </tr>
            `).join('');
        }

        function getCoverageClass(percentage) {
            if (percentage >= 80) return 'coverage-high';
            if (percentage >= 60) return 'coverage-medium';
            return 'coverage-low';
        }

        // Update recommendations
        function updateRecommendations(data) {
            const container = document.getElementById('recommendations-list');
            const recommendations = data.recommendations || [];

            if (recommendations.length === 0) {
                container.innerHTML = '<p>No specific recommendations at this time.</p>';
                return;
            }

            container.innerHTML = recommendations.slice(0, 10).map(rec => `
                <div class="recommendation-item recommendation-${rec.priority}">
                    <h4>${rec.type === 'threshold' ? 'Coverage Threshold' :
                          rec.type === 'file' ? 'File Coverage' :
                          rec.type === 'uncovered' ? 'Uncovered Code' : 'Recommendation'}</h4>
                    <p>${rec.suggestion}</p>
                    ${rec.current !== undefined ? `<small>Current: ${rec.current}% | Target: ${rec.target}%</small>` : ''}
                </div>
            `).join('');
        }

        // Update generated date
        function updateGeneratedDate(data) {
            const dateElement = document.getElementById('generated-date');
            if (data.metadata && data.metadata.generatedAt) {
                const date = new Date(data.metadata.generatedAt);
                dateElement.textContent = date.toLocaleString();
            } else {
                dateElement.textContent = new Date().toLocaleString();
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            const data = await loadCoverageData();

            if (!data) {
                document.querySelector('.container').innerHTML = `
                    <div style="text-align: center; padding: 100px; background: white; border-radius: 10px; margin: 50px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h2 style="color: #dc3545; margin-bottom: 20px;">Coverage Data Not Found</h2>
                        <p style="color: #666; margin-bottom: 30px;">Please run the coverage analysis first:</p>
                        <code style="background: #f8f9fa; padding: 10px 20px; border-radius: 5px; font-family: monospace;">node test-coverage-analysis.js</code>
                    </div>
                `;
                return;
            }

            updateMetrics(data);
            createCoverageChart(data);
            createDirectoryChart(data);
            updateFilesTable(data);
            updateRecommendations(data);
            updateGeneratedDate(data);
        }

        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>